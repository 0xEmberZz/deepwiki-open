# syntax=docker/dockerfile:1-labs
# Railway 专用 Dockerfile

FROM node:20-alpine3.22 AS node_base

FROM node_base AS node_deps
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci --legacy-peer-deps

FROM node_base AS node_builder
WORKDIR /app
COPY --from=node_deps /app/node_modules ./node_modules
COPY package.json package-lock.json next.config.ts tsconfig.json tailwind.config.js postcss.config.mjs ./
COPY src/ ./src/
COPY public/ ./public/
ENV NODE_OPTIONS="--max-old-space-size=4096"
ENV NEXT_TELEMETRY_DISABLED=1
RUN NODE_ENV=production npm run build

FROM python:3.11-slim AS py_deps
WORKDIR /api
COPY api/pyproject.toml .
COPY api/poetry.lock .
RUN python -m pip install poetry==2.0.1 --no-cache-dir && \
    poetry config virtualenvs.create true --local && \
    poetry config virtualenvs.in-project true --local && \
    poetry config virtualenvs.options.always-copy --local true && \
    POETRY_MAX_WORKERS=10 poetry install --no-interaction --no-ansi --only main && \
    poetry cache clear --all .

FROM python:3.11-slim

WORKDIR /app

# 安装 Node.js 和必要工具
RUN apt-get update && apt-get install -y \
    curl \
    gnupg \
    git \
    ca-certificates \
    && mkdir -p /etc/apt/keyrings \
    && curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg \
    && echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list \
    && apt-get update \
    && apt-get install -y nodejs \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

ENV PATH="/opt/venv/bin:$PATH"

# 复制 Python 依赖
COPY --from=py_deps /api/.venv /opt/venv
COPY api/ ./api/

# 复制 Node 应用
COPY --from=node_builder /app/public ./public
COPY --from=node_builder /app/.next/standalone ./
COPY --from=node_builder /app/.next/static ./.next/static

# 创建数据目录
RUN mkdir -p /root/.adalflow/repos /root/.adalflow/databases /root/.adalflow/wikicache

# Railway 启动脚本
# - 后端使用固定端口 8001（内部通信）
# - 前端使用 Railway 提供的 $PORT（外部访问）
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
# 保存 Railway 提供的端口给前端\n\
FRONTEND_PORT=${PORT:-3000}\n\
API_PORT=8001\n\
\n\
echo "=== DeepWiki Railway Deployment ==="\n\
echo "API Port (internal): $API_PORT"\n\
echo "Frontend Port (external): $FRONTEND_PORT"\n\
\n\
if [ -z "$OPENAI_API_KEY" ] && [ -z "$GOOGLE_API_KEY" ]; then\n\
  echo "Warning: Neither OPENAI_API_KEY nor GOOGLE_API_KEY is set."\n\
fi\n\
\n\
export SERVER_BASE_URL="http://localhost:${API_PORT}"\n\
\n\
# 启动后端（设置 PORT=8001 覆盖 Railway 的值）\n\
PORT=${API_PORT} python -m api.main &\n\
\n\
# 等待后端启动（最多等待 60 秒）\n\
echo "Waiting for backend to start..."\n\
for i in $(seq 1 60); do\n\
  if curl -s http://localhost:${API_PORT}/health > /dev/null 2>&1; then\n\
    echo "Backend is ready!"\n\
    break\n\
  fi\n\
  echo "Waiting... ($i/60)"\n\
  sleep 1\n\
done\n\
\n\
# 启动前端（使用 Railway 提供的端口）\n\
PORT=${FRONTEND_PORT} HOSTNAME=0.0.0.0 node server.js &\n\
\n\
wait -n\n\
exit $?' > /app/start.sh && chmod +x /app/start.sh

ENV NODE_ENV=production

CMD ["/app/start.sh"]
